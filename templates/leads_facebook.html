{% extends "base.html" %}

{% block title %}Leads de Facebook - ERP Sistema{% endblock %}

{% block extra_css %}
<style>
    .lead-card {
        border-left: 4px solid #1877f2;
        transition: all 0.3s ease;
    }
    
    .lead-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .estado-nuevo { border-left-color: #28a745; }
    .estado-contactado { border-left-color: #ffc107; }
    .estado-calificado { border-left-color: #17a2b8; }
    .estado-convertido { border-left-color: #6f42c1; }
    .estado-descartado { border-left-color: #dc3545; }
    
    .facebook-icon {
        color: #1877f2;
        font-size: 1.2em;
    }
    
    .btn-action {
        margin: 2px;
        font-size: 0.8em;
        padding: 4px 8px;
    }
    
    .stats-card {
        background: linear-gradient(135deg, #1877f2, #42a5f5);
        color: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .import-section {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        border: 2px dashed #1877f2;
    }
    
    .lead-actions {
        display: flex;
        gap: 5px;
        flex-wrap: wrap;
    }
    
    @media (max-width: 768px) {
        .lead-actions {
            flex-direction: column;
        }
        
        .btn-action {
            margin-bottom: 5px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>
                    <i class="fab fa-facebook facebook-icon"></i>
                    Leads de Facebook
                </h2>
                <div>
                    <button class="btn btn-primary" onclick="importarLeadsFacebook()">
                        <i class="fas fa-download"></i> Importar Leads
                    </button>
                    <a href="{{ url_for('crm') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Volver al CRM
                    </a>
                </div>
            </div>

            <!-- Estadísticas -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="stats-card text-center">
                        <h3 id="total-leads">{{ leads|length }}</h3>
                        <p class="mb-0">Total Leads</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card text-center">
                        <h3 id="leads-nuevos">
                            {{ leads|selectattr('6', 'equalto', 'nuevo')|list|length }}
                        </h3>
                        <p class="mb-0">Nuevos</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card text-center">
                        <h3 id="leads-contactados">
                            {{ leads|selectattr('6', 'equalto', 'contactado')|list|length }}
                        </h3>
                        <p class="mb-0">Contactados</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card text-center">
                        <h3 id="leads-convertidos">
                            {{ leads|selectattr('6', 'equalto', 'convertido')|list|length }}
                        </h3>
                        <p class="mb-0">Convertidos</p>
                    </div>
                </div>
            </div>

            <!-- Sección de Importación -->
            <div class="import-section">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h5><i class="fas fa-cloud-download-alt"></i> Importar Leads Automáticamente</h5>
                        <p class="mb-0 text-muted">Sincroniza los últimos leads de tus formularios de Facebook</p>
                    </div>
                    <div class="col-md-4 text-right">
                        <button class="btn btn-success btn-lg" onclick="importarLeadsFacebook()">
                            <i class="fas fa-sync-alt"></i> Sincronizar Ahora
                        </button>
                    </div>
                </div>
            </div>

            <!-- Filtros -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <label for="filtro-estado">Estado:</label>
                            <select id="filtro-estado" class="form-control" onchange="filtrarLeads()">
                                <option value="">Todos los estados</option>
                                <option value="nuevo">Nuevo</option>
                                <option value="contactado">Contactado</option>
                                <option value="calificado">Calificado</option>
                                <option value="convertido">Convertido</option>
                                <option value="descartado">Descartado</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="filtro-fecha">Fecha:</label>
                            <select id="filtro-fecha" class="form-control" onchange="filtrarLeads()">
                                <option value="">Todas las fechas</option>
                                <option value="hoy">Hoy</option>
                                <option value="semana">Esta semana</option>
                                <option value="mes">Este mes</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="buscar-lead">Buscar:</label>
                            <input type="text" id="buscar-lead" class="form-control" 
                                   placeholder="Buscar por nombre o email..." onkeyup="filtrarLeads()">
                        </div>
                        <div class="col-md-2">
                            <label>&nbsp;</label>
                            <button class="btn btn-outline-secondary form-control" onclick="limpiarFiltros()">
                                <i class="fas fa-times"></i> Limpiar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lista de Leads -->
            <div id="leads-container">
                {% if leads %}
                    <div class="row">
                        {% for lead in leads %}
                        <div class="col-lg-6 col-xl-4 mb-4 lead-item" 
                             data-estado="{{ lead[4] }}" 
                             data-fecha="{{ lead[5].strftime('%Y-%m-%d') if lead[5] else '' }}"
                             data-nombre="{{ lead[1].lower() if lead[1] else '' }}"
                             data-email="{{ lead[2].lower() if lead[2] else '' }}">
                            <div class="card lead-card estado-{{ lead[4] }}">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>{{ lead[1] or 'Sin nombre' }}</strong>
                                        <span class="badge badge-{{ 
                                            'success' if lead[4] == 'nuevo' else
                                            'warning' if lead[4] == 'contactado' else
                                            'info' if lead[4] == 'calificado' else
                                            'primary' if lead[4] == 'convertido' else
                                            'danger'
                                        }} ml-2">{{ lead[4].title() }}</span>
                                    </div>
                                    <i class="fab fa-facebook facebook-icon"></i>
                                </div>
                                <div class="card-body">
                                    <div class="mb-2">
                                        <i class="fas fa-envelope text-muted"></i>
                                        <small>{{ lead[2] or 'Sin email' }}</small>
                                    </div>
                                    <div class="mb-2">
                                        <i class="fas fa-phone text-muted"></i>
                                        <small>{{ lead[3] or 'Sin teléfono' }}</small>
                                    </div>
                                    <div class="mb-3">
                                        <i class="fas fa-calendar text-muted"></i>
                                        <small>{{ moment(lead[5]).format('DD/MM/YYYY HH:mm') if lead[5] else 'Sin fecha' }}</small>
                                    </div>
                                    
                                    {% if lead[6] %}
                                    <div class="mb-2">
                                        <small class="text-muted">
                                            <strong>ID Facebook:</strong> {{ lead[6][:20] }}...
                                        </small>
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="card-footer">
                                    <div class="lead-actions">
                                        {% if lead[4] == 'nuevo' %}
                                        <button class="btn btn-warning btn-action" 
                                                onclick="contactarLead('{{ lead[0] }}')">
                                            <i class="fas fa-phone"></i> Contactar
                                        </button>
                                        {% endif %}
                                        
                                        {% if lead[4] in ['nuevo', 'contactado'] %}
                                        <button class="btn btn-info btn-action"
                                                onclick="calificarLead('{{ lead[0] }}')">
                                            <i class="fas fa-star"></i> Calificar
                                        </button>
                                        {% endif %}
                                        
                                        {% if lead[4] in ['contactado', 'calificado'] %}
                                        <button class="btn btn-success btn-action"
                                                onclick="convertirLead('{{ lead[0] }}')">
                                            <i class="fas fa-user-plus"></i> Convertir
                                        </button>
                                        {% endif %}
                                        
                                        <button class="btn btn-outline-primary btn-action"
                                                onclick="verDetallesLead('{{ lead[0] }}')">
                                            <i class="fas fa-eye"></i> Ver
                                        </button>
                                        
                                        {% if lead[4] != 'convertido' %}
                                        <button class="btn btn-outline-danger btn-action"
                                                onclick="descartarLead('{{ lead[0] }}')">
                                            <i class="fas fa-times"></i> Descartar
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="fab fa-facebook facebook-icon" style="font-size: 4em; opacity: 0.3;"></i>
                        <h4 class="mt-3 text-muted">No hay leads de Facebook</h4>
                        <p class="text-muted">Los leads importados desde Facebook aparecerán aquí</p>
                        <button class="btn btn-primary btn-lg" onclick="importarLeadsFacebook()">
                            <i class="fas fa-download"></i> Importar Primer Lead
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal para Calificar Lead -->
<div class="modal fade" id="modalCalificarLead" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Calificar Lead</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="formCalificarLead">
                    <input type="hidden" id="leadIdCalificar">
                    <div class="form-group">
                        <label>Calificación:</label>
                        <select class="form-control" id="calificacionLead" required>
                            <option value="calificado">Calificado (Interesado)</option>
                            <option value="no_calificado">No Calificado</option>
                            <option value="descartado">Descartado</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Notas:</label>
                        <textarea class="form-control" id="notasCalificacion" rows="3" 
                                  placeholder="Agregar notas sobre la calificación..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="guardarCalificacion()">
                    Guardar Calificación
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Ver Detalles -->
<div class="modal fade" id="modalDetallesLead" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalles del Lead</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body" id="contenidoDetallesLead">
                <!-- Contenido cargado dinámicamente -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Función para importar leads de Facebook
function importarLeadsFacebook() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Importando...';
    btn.disabled = true;
    
    fetch('/api/facebook/leads/importar', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            mostrarAlerta('success', data.message);
            setTimeout(() => location.reload(), 2000);
        } else {
            mostrarAlerta('error', 'Error: ' + data.message);
        }
    })
    .catch(error => {
        mostrarAlerta('error', 'Error de conexión: ' + error.message);
    })
    .finally(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
}

// Función para contactar lead
function contactarLead(leadId) {
    if (confirm('¿Marcar este lead como contactado?')) {
        fetch(`/api/leads/${leadId}/contactar`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                mostrarAlerta('success', data.message);
                setTimeout(() => location.reload(), 1500);
            } else {
                mostrarAlerta('error', 'Error: ' + data.message);
            }
        })
        .catch(error => {
            mostrarAlerta('error', 'Error de conexión: ' + error.message);
        });
    }
}

// Función para abrir modal de calificación
function calificarLead(leadId) {
    document.getElementById('leadIdCalificar').value = leadId;
    $('#modalCalificarLead').modal('show');
}

// Función para guardar calificación
function guardarCalificacion() {
    const leadId = document.getElementById('leadIdCalificar').value;
    const calificacion = document.getElementById('calificacionLead').value;
    const notas = document.getElementById('notasCalificacion').value;
    
    fetch(`/api/leads/${leadId}/calificar`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            calificacion: calificacion,
            notas: notas
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            $('#modalCalificarLead').modal('hide');
            mostrarAlerta('success', data.message);
            setTimeout(() => location.reload(), 1500);
        } else {
            mostrarAlerta('error', 'Error: ' + data.message);
        }
    })
    .catch(error => {
        mostrarAlerta('error', 'Error de conexión: ' + error.message);
    });
}

// Función para convertir lead
function convertirLead(leadId) {
    if (confirm('¿Convertir este lead en cliente? Esta acción creará un nuevo registro en la base de clientes.')) {
        fetch(`/api/leads/${leadId}/convertir`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                mostrarAlerta('success', data.message);
                setTimeout(() => location.reload(), 2000);
            } else {
                mostrarAlerta('error', 'Error: ' + data.message);
            }
        })
        .catch(error => {
            mostrarAlerta('error', 'Error de conexión: ' + error.message);
        });
    }
}

// Función para descartar lead
function descartarLead(leadId) {
    if (confirm('¿Descartar este lead? Podrás revertir esta acción más tarde.')) {
        fetch(`/api/leads/${leadId}/calificar`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                calificacion: 'descartado',
                notas: 'Lead descartado manualmente'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                mostrarAlerta('warning', 'Lead descartado correctamente');
                setTimeout(() => location.reload(), 1500);
            } else {
                mostrarAlerta('error', 'Error: ' + data.message);
            }
        })
        .catch(error => {
            mostrarAlerta('error', 'Error de conexión: ' + error.message);
        });
    }
}

// Función para ver detalles del lead
function verDetallesLead(leadId) {
    // Aquí podrías hacer una llamada AJAX para obtener más detalles
    document.getElementById('contenidoDetallesLead').innerHTML = `
        <div class="text-center">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p>Cargando detalles del lead...</p>
        </div>
    `;
    $('#modalDetallesLead').modal('show');
    
    // Simular carga de detalles (puedes implementar una ruta real)
    setTimeout(() => {
        document.getElementById('contenidoDetallesLead').innerHTML = `
            <div class="alert alert-info">
                <strong>Funcionalidad en desarrollo</strong><br>
                Los detalles completos del lead se mostrarán aquí.
                <br><br>
                <strong>ID del Lead:</strong> ${leadId}
            </div>
        `;
    }, 1000);
}

// Función para filtrar leads
function filtrarLeads() {
    const filtroEstado = document.getElementById('filtro-estado').value.toLowerCase();
    const filtroFecha = document.getElementById('filtro-fecha').value;
    const busqueda = document.getElementById('buscar-lead').value.toLowerCase();
    
    const leads = document.querySelectorAll('.lead-item');
    const hoy = new Date();
    
    leads.forEach(lead => {
        let mostrar = true;
        
        // Filtro por estado
        if (filtroEstado && lead.dataset.estado !== filtroEstado) {
            mostrar = false;
        }
        
        // Filtro por búsqueda
        if (busqueda && 
            !lead.dataset.nombre.includes(busqueda) && 
            !lead.dataset.email.includes(busqueda)) {
            mostrar = false;
        }
        
        // Filtro por fecha
        if (filtroFecha && lead.dataset.fecha) {
            const fechaLead = new Date(lead.dataset.fecha);
            
            switch(filtroFecha) {
                case 'hoy':
                    if (fechaLead.toDateString() !== hoy.toDateString()) {
                        mostrar = false;
                    }
                    break;
                case 'semana':
                    const inicioSemana = new Date(hoy);
                    inicioSemana.setDate(hoy.getDate() - hoy.getDay());
                    if (fechaLead < inicioSemana) {
                        mostrar = false;
                    }
                    break;
                case 'mes':
                    if (fechaLead.getMonth() !== hoy.getMonth() || 
                        fechaLead.getFullYear() !== hoy.getFullYear()) {
                        mostrar = false;
                    }
                    break;
            }
        }
        
        lead.style.display = mostrar ? 'block' : 'none';
    });
}

// Función para limpiar filtros
function limpiarFiltros() {
    document.getElementById('filtro-estado').value = '';
    document.getElementById('filtro-fecha').value = '';
    document.getElementById('buscar-lead').value = '';
    filtrarLeads();
}

// Función para mostrar alertas
function mostrarAlerta(tipo, mensaje) {
    const alertaHtml = `
        <div class="alert alert-${tipo === 'success' ? 'success' : tipo === 'warning' ? 'warning' : 'danger'} alert-dismissible fade show" role="alert">
            ${mensaje}
            <button type="button" class="close" data-dismiss="alert">
                <span>&times;</span>
            </button>
        </div>
    `;
    
    // Insertar alerta al inicio del contenido
    const container = document.querySelector('.container-fluid');
    container.insertAdjacentHTML('afterbegin', alertaHtml);
    
    // Auto-ocultar después de 5 segundos
    setTimeout(() => {
        const alerta = container.querySelector('.alert');
        if (alerta) {
            alerta.remove();
        }
    }, 5000);
}

// Inicialización cuando se carga la página
document.addEventListener('DOMContentLoaded', function() {
    // Verificar conexión con Facebook cada 5 minutos
    setInterval(() => {
        fetch('/api/facebook/test-conexion', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                console.warn('Conexión con Facebook perdida:', data.message);
            }
        })
        .catch(error => {
            console.warn('Error verificando conexión Facebook:', error);
        });
    }, 300000); // 5 minutos
});
</script>
{% endblock %}